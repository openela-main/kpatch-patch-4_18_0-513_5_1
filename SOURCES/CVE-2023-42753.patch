From d6769160e182681646d667c1d9eb515d7150f004 Mon Sep 17 00:00:00 2001
From: Joe Lawrence <joe.lawrence@redhat.com>
Date: Mon, 27 Nov 2023 15:48:49 -0500
Subject: [KPATCH CVE-2023-42753] kpatch fixes for CVE-2023-42753

Kernels:
4.18.0-513.5.1.el8_9


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-8/-/merge_requests/185
Changes since last build:
[x86_64]:
af_unix.o: changed function: unix_bind
af_unix.o: changed function: unix_stream_sendpage
ip_set_hash_netportnet.o: changed function: hash_netportnet4_uadt
ip_set_hash_netportnet.o: changed function: hash_netportnet6_uadt

[ppc64le]:
af_unix.o: changed function: unix_stream_sendpage
ip_set_hash_netportnet.o: changed function: hash_netportnet4_uadt
ip_set_hash_netportnet.o: changed function: hash_netportnet6_uadt

---------------------------

Modifications:
- Z-stream sets IP_SET_HASH_WITH_NET0, which kicks off a bunch of
  preprocessor defined function and data changes, including struct
  hash_netportnet{4,6}.nets[] array sizing and iteration.  Instead of
  deploying shadow variables to trace new/old instances, just reject
  CIDR/CIDR2 if they are 0, i.e. remove support for /0 wildcard matching
  so users get an error when they try to insert a new /0 element.

commit d36270bf121c7495f1a50e09c0c09db00a38d73f
Author: Florian Westphal <fwestpha@redhat.com>
Date:   Thu Oct 5 12:25:28 2023 +0200

    netfilter: ipset: add the missing IP_SET_HASH_WITH_NET0 macro for ip_set_hash_netportnet.c

    JIRA: https://issues.redhat.com/browse/RHEL-8443
    CVE: CVE-2023-42753
    Y-Commit: 0020caf6c194a899feaa289726fc2d2cb6e586cf

    O-JIRA: https://issues.redhat.com/browse/RHEL-8444
    O-CVE: CVE-2023-42753
    Upstream Status: commit 050d91c03b28

    commit 050d91c03b28ca479df13dfb02bcd2c60dd6a878
    Author: Kyle Zeng <zengyhkyle@gmail.com>
    Date:   Tue Sep 5 15:04:09 2023 -0700

        netfilter: ipset: add the missing IP_SET_HASH_WITH_NET0 macro for ip_set_hash_netportnet.c

        The missing IP_SET_HASH_WITH_NET0 macro in ip_set_hash_netportnet can
        lead to the use of wrong `CIDR_POS(c)` for calculating array offsets,
        which can lead to integer underflow. As a result, it leads to slab
        out-of-bound access.
        This patch adds back the IP_SET_HASH_WITH_NET0 macro to
        ip_set_hash_netportnet to address the issue.

        Fixes: 886503f34d63 ("netfilter: ipset: actually allow allowable CIDR 0 in hash:net,port,net")
        Suggested-by: Jozsef Kadlecsik <kadlec@netfilter.org>
        Signed-off-by: Kyle Zeng <zengyhkyle@gmail.com>
        Acked-by: Jozsef Kadlecsik <kadlec@netfilter.org>
        Signed-off-by: Florian Westphal <fw@strlen.de>

    Signed-off-by: Florian Westphal <fwestpha@redhat.com>
    Signed-off-by: Patrick Talbert <ptalbert@redhat.com>

Signed-off-by: Joe Lawrence <joe.lawrence@redhat.com>
---
 net/netfilter/ipset/ip_set_hash_netportnet.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/net/netfilter/ipset/ip_set_hash_netportnet.c b/net/netfilter/ipset/ip_set_hash_netportnet.c
index 2adc0bdba59b..c7cb6f574f10 100644
--- a/net/netfilter/ipset/ip_set_hash_netportnet.c
+++ b/net/netfilter/ipset/ip_set_hash_netportnet.c
@@ -223,12 +223,16 @@ hash_netportnet4_uadt(struct ip_set *set, struct nlattr *tb[],
 
 	if (tb[IPSET_ATTR_CIDR]) {
 		e.cidr[0] = nla_get_u8(tb[IPSET_ATTR_CIDR]);
+		if (e.cidr[0] == 0)
+			return -IPSET_ERR_INVALID_CIDR;
 		if (e.cidr[0] > HOST_MASK)
 			return -IPSET_ERR_INVALID_CIDR;
 	}
 
 	if (tb[IPSET_ATTR_CIDR2]) {
 		e.cidr[1] = nla_get_u8(tb[IPSET_ATTR_CIDR2]);
+		if (e.cidr[1] == 0)
+			return -IPSET_ERR_INVALID_CIDR;
 		if (e.cidr[1] > HOST_MASK)
 			return -IPSET_ERR_INVALID_CIDR;
 	}
@@ -509,12 +513,16 @@ hash_netportnet6_uadt(struct ip_set *set, struct nlattr *tb[],
 
 	if (tb[IPSET_ATTR_CIDR]) {
 		e.cidr[0] = nla_get_u8(tb[IPSET_ATTR_CIDR]);
+		if (e.cidr[0] == 0)
+			return -IPSET_ERR_INVALID_CIDR;
 		if (e.cidr[0] > HOST_MASK)
 			return -IPSET_ERR_INVALID_CIDR;
 	}
 
 	if (tb[IPSET_ATTR_CIDR2]) {
 		e.cidr[1] = nla_get_u8(tb[IPSET_ATTR_CIDR2]);
+		if (e.cidr[1] == 0)
+			return -IPSET_ERR_INVALID_CIDR;
 		if (e.cidr[1] > HOST_MASK)
 			return -IPSET_ERR_INVALID_CIDR;
 	}
-- 
2.43.0


