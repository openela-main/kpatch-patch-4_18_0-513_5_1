From 7cbbb143f55d609d5f571d24e575a4b282a270a9 Mon Sep 17 00:00:00 2001
From: Joe Lawrence <joe.lawrence@redhat.com>
Date: Tue, 30 Jan 2024 14:06:37 -0500
Subject: [KPATCH CVE-2024-0646] kpatch fixes for CVE-2024-0646

Kernels:
4.18.0-513.5.1.el8_9
4.18.0-513.9.1.el8_9
4.18.0-513.11.1.el8_9


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-8/-/merge_requests/216
Changes since last build:
[x86_64]:
igb_main.o: changed function: igb_configure
sch_atm.o: changed function: atm_tc_peek
sch_atm.o: changed function: sch_atm_dequeue
sch_drr.o: changed function: drr_dequeue
sch_dsmark.o: changed function: dsmark_peek
sch_ets.o: changed function: ets_qdisc_dequeue
sch_hfsc.o: changed function: hfsc_change_class
sch_hfsc.o: changed function: hfsc_enqueue
sch_hfsc.o: changed function: qdisc_peek_len
sch_multiq.o: changed function: multiq_peek
sch_prio.o: changed function: prio_peek
sch_qfq.o: changed function: qfq_dequeue
sch_qfq.o: changed function: qfq_enqueue
sch_red.o: changed function: red_peek
sch_sfb.o: changed function: sfb_peek
sch_tbf.o: changed function: tbf_dequeue
tls_sw.o: changed function: tls_sw_do_sendpage

[ppc64le]:
sch_atm.o: changed function: atm_tc_bind_filter
sch_atm.o: changed function: atm_tc_delete
sch_atm.o: changed function: atm_tc_destroy
sch_atm.o: changed function: atm_tc_find
sch_atm.o: changed function: atm_tc_graft
sch_atm.o: changed function: atm_tc_leaf
sch_atm.o: changed function: atm_tc_peek
sch_atm.o: changed function: atm_tc_put
sch_atm.o: changed function: atm_tc_reset
sch_atm.o: changed function: atm_tc_tcf_block
sch_atm.o: changed function: sch_atm_dequeue
sch_drr.o: changed function: drr_dequeue
sch_dsmark.o: changed function: dsmark_bind_filter
sch_dsmark.o: changed function: dsmark_change
sch_dsmark.o: changed function: dsmark_destroy
sch_dsmark.o: changed function: dsmark_peek
sch_dsmark.o: changed function: dsmark_reset
sch_ets.o: changed function: ets_qdisc_dequeue
sch_hfsc.o: changed function: hfsc_change_class
sch_hfsc.o: changed function: hfsc_dequeue
sch_hfsc.o: changed function: hfsc_enqueue
sch_hfsc.o: new function: qdisc_peek_len
sch_multiq.o: changed function: multiq_peek
sch_prio.o: changed function: prio_peek
sch_qfq.o: changed function: qfq_dequeue
sch_qfq.o: changed function: qfq_enqueue
sch_red.o: changed function: red_peek
sch_sfb.o: changed function: sfb_peek
sch_tbf.o: changed function: tbf_dequeue
tls_sw.o: changed function: tls_sw_do_sendpage

---------------------------

Modifications: none

commit 921f1c2f10343e90a9815b14e35d739e0dfe1e92
Author: Sabrina Dubroca <sdubroca@redhat.com>
Date:   Thu Jan 18 15:44:58 2024 +0100

    net: tls, update curr on splice as well

    JIRA: https://issues.redhat.com/browse/RHEL-22091
    CVE: CVE-2024-0646
    Y-Commit: 0524759c9c57705e6f126b6b5d173040d952fe94

    O-JIRA: https://issues.redhat.com/browse/RHEL-19065
    O-CVE: CVE-2024-0646
    Tested: selftests + reproducer

    Conflict: apply the changes to tls_sw_do_sendpage, missing the big
      splice rework (fe1e81d4f73b and 45e5be844ab6)

    commit c5a595000e2677e865a39f249c056bc05d6e55fd
    Author: John Fastabend <john.fastabend@gmail.com>
    Date:   Wed Dec 6 15:27:05 2023 -0800

        net: tls, update curr on splice as well

        The curr pointer must also be updated on the splice similar to how
        we do this for other copy types.

        Fixes: d829e9c4112b ("tls: convert to generic sk_msg interface")
        Signed-off-by: John Fastabend <john.fastabend@gmail.com>
        Reported-by: Jann Horn <jannh@google.com>
        Link: https://lore.kernel.org/r/20231206232706.374377-2-john.fastabend@gmail.com
        Signed-off-by: Jakub Kicinski <kuba@kernel.org>

    Signed-off-by: Sabrina Dubroca <sdubroca@redhat.com>
    Signed-off-by: Patrick Talbert <ptalbert@redhat.com>

Signed-off-by: Joe Lawrence <joe.lawrence@redhat.com>
---
 net/tls/tls_sw.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/net/tls/tls_sw.c b/net/tls/tls_sw.c
index 731caaa88aa5..e068b63170f4 100644
--- a/net/tls/tls_sw.c
+++ b/net/tls/tls_sw.c
@@ -1213,6 +1213,8 @@ static int tls_sw_do_sendpage(struct sock *sk, struct page *page,
 		}
 
 		sk_msg_page_add(msg_pl, page, copy, offset);
+		msg_pl->sg.copybreak = 0;
+		msg_pl->sg.curr = msg_pl->sg.end;
 		sk_mem_charge(sk, copy);
 
 		offset += copy;
-- 
2.43.0


